<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SORA</title>
    <!-- (BOOTSTRAP)CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous" />

    <!--bootstrap-->
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="./vendor/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="./fonts/font-awesome-4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="./fonts/Linearicons-Free-v1.0.0/icon-font.min.css" />

    <link rel="stylesheet" type="text/css" href="./vendor/animate/animate.css" />

    <link rel="stylesheet" type="text/css" href="./vendor/css-hamburgers/hamburgers.min.css" />
    <link rel="stylesheet" type="text/css" href="./vendor/animsition/css/animsition.min.css" />

    <link rel="stylesheet" type="text/css" href="./vendor/select2/select2.min.css" />

    <link rel="stylesheet" type="text/css" href="./vendor/daterangepicker/daterangepicker.css" />

    <link rel="stylesheet" type="text/css" href="./css/util.css" />
    <link rel="stylesheet" type="text/css" href="./css/main.css" />
    <!--===============================================================================================-->

    <link href="./styles/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <link href="./styles/buttons.css" type="text/css" rel="stylesheet" />
    <link href="./styles/style_1.css" type="text/css" rel="stylesheet" />

    <!--my own css-->
    <link rel="stylesheet" href="./style/style.css" />

    <!-- (BOOTSTRAP)JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
    <!--jQuery here-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <!--Select2-->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.5/pagination.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.5/pagination.min.js"></script> -->

    <!--axios-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.20.0/axios.js"></script>
</head>

<body>
    <header class="nav_header">
        <nav>
            <div class="logo">
                <a class="logolink" href="#">SORA</a>
            </div>
            <div class="modify_search" id="modify_search">修改搜尋條件</div>
            <div id="hide_search">隱藏搜尋條件</div>
            <div id="div_profile">
                <div>
                    <button id="trigger_profile">會員資料</button>
                </div>
            </div>
            <div id="show_signin">
                <div>
                    <button id="trigger_show_signin">登入</button>
                </div>
            </div>
            <div id="show_signup">
                <div>
                    <button id="trigger_show_signup">註冊</button>
                </div>
            </div>

            <!--Sign Up-->
            <!-- <div id="div_signup">
                <div>
                    <p>註冊</p>
                </div>
                <div>
                    <label for="name">name</label>
                    <input type="text" name="name" id="signup_input_name" />
                </div>
                <div>
                    <label for="email">email</label>
                    <input type="text" name="email" id="signup_input_email" />
                </div>
                <div>
                    <label for="password">password</label>
                    <input type="password" name="password" id="signup_input_password" />
                </div>
                <button id="trigger_signup">Submit</button>
            </div> -->
            <div class="container-login100" id="id_container-login100">
                <div class="wrap-login100 p-t-30 p-b-50">
                    <span class="login100-form-title p-b-41"> Account Login </span>
                    <div class="login100-form validate-form p-b-33 p-t-5">
                        <div class="wrap-input100 validate-input" data-validate="Enter username">
                            <input class="input100" id="signin_input_email" type="text" name="username" placeholder="User Email" />
                            <span class="focus-input100" data-placeholder="&#xe82a;"></span>
                        </div>

                        <div class="wrap-input100 validate-input" data-validate="Enter password">
                            <input class="input100" id="signin_input_password" type="password" name="pass" placeholder="Password" />
                            <span class="focus-input100" data-placeholder="&#xe80f;"></span>
                        </div>

                        <div class="container-login100-form-btn m-t-32">
                            <button class="login100-form-btn" id="trigger_signin">
                  Login
                </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-login100" id="id_container-register100">
                <div class="wrap-login100 p-t-30 p-b-50">
                    <span class="login100-form-title p-b-41"> Register </span>
                    <div class="login100-form validate-form p-b-33 p-t-5">
                        <div class="wrap-input100 validate-input" data-validate="Enter username">
                            <input class="input100" id="signup_input_name" type="text" name="username" placeholder="User Name" />
                            <span class="focus-input100" data-placeholder="&#xe82a;"></span>
                        </div>
                        <div class="wrap-input100 validate-input" data-validate="Enter username">
                            <input class="input100" id="signup_input_email" type="text" name="useremail" placeholder="User Email" />
                            <span class="focus-input100" data-placeholder="&#xe82a;"></span>
                        </div>

                        <div class="wrap-input100 validate-input" data-validate="Enter password">
                            <input class="input100" id="signup_input_password" type="password" name="pass" placeholder="Password" />
                            <span class="focus-input100" data-placeholder="&#xe80f;"></span>
                        </div>

                        <div class="container-login100-form-btn m-t-32">
                            <button class="login100-form-btn" id="trigger_signup">
                  Register
                </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- <div id="div_signin">
                <div>
                    <p>登入</p>
                </div>
                <div>
                    <label for="email">email</label>
                    <input type="text" name="email" id="signin_input_email" />
                </div>
                <div>
                    <label for="password">password</label>
                    <input type="password" name="password" id="signin_input_password" />
                </div>
                <button id="trigger_signin">Submit</button>
            </div> -->
            <div id="div_signout">
                <button id="trigger_signout">登出</button>
            </div>
        </nav>
    </header>
    <div id="root">
        <div id="filters">
            <div>
                <label for="id_label_0">
            店名
            <br />
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_0"
            ></select>
          </label>
            </div>

            <div>
                <label for="id_label_1">
            地點
            <br />
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_1"
            >
              <option value="TPE">台北</option>
              <option value="KAO">高雄</option>
              <option value="NTP">新北</option>
              <option value="TAN">台南</option>
              <option value="HSC">新竹</option>
              <option value="HSC">淡水</option>
              <option value="HSC">文化路</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_2">
            異國料理
            <br />
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_2"
            >
              <option value="TPE">日式</option>
              <option value="KAO">中式</option>
              <option value="NTP">韓式</option>
              <option value="TAN">美式</option>
              <option value="HSC">泰式</option>
              <option value="HSC">港式</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_3">
            餐廳類型
            <br />
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_3"
            >
              <option value="TPE">咖啡廳</option>
              <option value="KAO">居酒屋</option>
              <option value="NTP">餐酒館</option>
              <option value="TAN">酒吧</option>
              <option value="HSC">甜點店</option>
              <option value="HSC">火鍋店</option>
              <option value="TAN">茶館</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_4">
            餐點名稱
            <br />
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_4"
            >
              <option value="TAN">炸魚薯條</option>
              <option value="TPE">炸豬排</option>
              <option value="KAO">松鼠桂魚</option>
              <option value="NTP">麻婆豆腐</option>
              <option value="TAN">時雨煮</option>
              <option value="HSC">三種起司披薩</option>
              <option value="HSC">上海菜飯</option>
              <option value="HSC">涼拌鮟鱇魚肝</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_5">
            價位
            <br />
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_5"
            >
              <option value="TPE">$</option>
              <option value="KAO">$$</option>
              <option value="NTP">$$$</option>
              <option value="TAN">$$$$</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_6">
            評價(3分往上)
            <br />
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_6"
            >
              <option value="TPE">1</option>
              <option value="KAO">2</option>
              <option value="NTP">3</option>
              <option value="TAN">4</option>
              <option value="HSC">4.5</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_7">
            供餐時段
            <br />
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_7"
            >
              <option value="TPE">早餐</option>
              <option value="KAO">早午餐</option>
              <option value="NTP">午餐</option>
              <option value="TAN">下午茶</option>
              <option value="HSC">晚餐</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_8">
            服務
            <br />
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_8"
            >
              <option value="TPE">外帶</option>
              <option value="KAO">外送</option>
              <option value="NTP">寵物友善</option>
              <option value="TAN">兒童座椅</option>
              <option value="HSC">停車場</option>
              <option value="PLUG">插座</option>
              <option value="PLUG">吃到飽</option>
              <option value="PLUG">預約制</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_9">
            營業中
            <br />
            <select
              class="js-example-basic-single"
              name="states"
              id="id_label_9"
            >
              <option value="TRUE">是</option>
              <option value="FALSE">否</option>
            </select>
          </label>
            </div>
            <div id="selected_fire_container">
                <!-- <button id="selected_fire">SORA!!</button> -->
                <button type="button" id="selected_fire" class="btn btn-warning btn-lg">
            S O R A
          </button>
            </div>
        </div>
    </div>
    <!--Bootstrap-->
    <!--===============================================================================================-->
    <!-- <script src="vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="vendor/animsition/js/animsition.min.js"></script>
    <script src="vendor/bootstrap/js/popper.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/select2/select2.min.js"></script>
    <script src="vendor/daterangepicker/moment.min.js"></script>
    <script src="vendor/daterangepicker/daterangepicker.js"></script>
    <script src="vendor/countdowntime/countdowntime.js"></script>
    <script src="js/main.js"></script> -->

    <script>
        let cnt = 0;
        let hits_arr = [];
        let page_len = 0;
        let personal_token;
        let friends_set = new Set(),
            favorite_set = new Set();
        const main_host = "https://chipmunk.vip";

        // QQQ.目前是寫死的，不過之後要看看要不要改。畢竟feature可能會改。
        // 不過這次專案就這樣也可以
        const user_features = new Set([
            "name",
            "level",
            "birthday",
            "birthplace",
            "hobbies",
            "occupation",
            "age",
            "gender",
        ]);
        $(document).ready(() => {
            $(".js-example-basic-multiple").select2({
                tags: true,
            });
        });
        console.log("initial setting start...");

        $("#hide_search").hide();
        $("#modify_search").hide();
        $("#id_container-login100").hide();
        $("#id_container-register100").hide();

        // INITIAL CHECK: if token is there
        const token = localStorage.getItem("jwt");
        // check token and renew it if present
        if (!token) {
            $("#div_signout").hide();
            $("#div_profile").hide();
            $("#show_signin").show();
            $("#show_signup").show();
        } else {
            axios
                .post(
                    `${main_host}/verify_token`, {}, {
                        headers: {
                            "Access-Control-Allow-Origin": "*",
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                        },
                    }
                )
                .then((response) => {
                    if (response.data.new_token) {
                        // there is a valid token
                        localStorage.setItem("jwt", response.data.new_token);
                        personal_token = response.data.personal_token;
                        // personal_token is email
                        // successfully signed in initially
                        $("#show_signin").hide();
                        $("#show_signup").hide();
                        $("#div_signout").show();
                        console.log("valid token present; signed in currently.");
                    } else {
                        // token is invalid
                        console.log(JSON.stringify(response.data.state));
                        $("#div_signout").hide();
                        $("#div_profile").hide();
                        $("#show_signin").show();
                        $("#show_signup").show();
                    }
                })
                .catch((err) => {
                    // other error
                    console.log("error: ", err);
                    $("#div_signout").hide();
                    $("#div_profile").hide();
                    $("#show_signin").show();
                    $("#show_signup").show();
                });
        }

        const obj = axios
            .get(`${main_host}/profile`, {
                headers: {
                    "Access-Control-Allow-Origin": "*",
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
            })
            .then(
                (response) => {
                    const req_status = response.data.state;
                    console.log("response.data:", response.data);
                    // debugging msg
                    // profile_data contains only data decoded from token
                    const profile_data = response.data.profile;
                    // if not profile_data應該要處理一下，雖然目前應該不會發生
                    // let div_profile = $("<div></div>").attr({
                    //     id: "profile_container",
                    // });
                    // // friend list
                    // let div_friend = $("<div></div>").attr({
                    //     id: "friend_container",
                    // });
                    // // favorite restaurants/collection
                    // let div_favorite = $("<div></div>").attr({
                    //     id: "favorite_container",
                    // });
                    // $("#root").append(div_profile);
                    // $("#root").append(div_friend);
                    // $("#root").append(div_favorite);

                    //set personal token for more purposes
                    personal_token = profile_data["email"] ? profile_data["email"] : "";
                    // display available features of user

                    // for (k of Object.keys(profile_data)) {
                    // 這2個keys暫時不處理；放到其他按鈕來處理
                    //     if (k === "friends") {
                    //         continue;
                    //     } else if (k === "favorite") {
                    //         continue;
                    //     }
                    //     let profile_key = $("<p></p>").attr({
                    //         id: `profile_div_${k}`,
                    //     });
                    //     profile_key.html(`${k}: ${profile_data[k]}`);
                    //     div_profile.append(profile_key);
                    // }
                    // div_friend.append(
                    //     $("<button id='show_friend'>美食同好</button>")
                    // );
                    // div_favorite.append(
                    //     $("<button id='show_favorite'>口袋名單</button>")
                    // );
                    // get friend and favorite here
                    // UPDATE: friend done;
                    // should have token here
                    let email;
                    try {
                        email = personal_token.replace(".", "%2E");
                    } catch (err) {
                        console.log("error occurred when urlencoding email:", err);
                        return;
                    }

                    // get friend list here
                    axios
                        .get(`${main_host}/friends?email=${email}`, {
                            headers: {
                                "Access-Control-Allow-Origin": "*",
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                            },
                        })
                        .then((response) => {
                            try {
                                // const data = response.data;
                                // console.log("response data: ", data);
                                // const friend_box = $("<div></div>").attr({
                                //     class: "friend_box",
                                // });
                                // $("#friend_container").append(friend_box);

                                for (d of data) {
                                    // const friend_case = $("<div></div>").attr({
                                    //     class: "friend_case",
                                    // });

                                    const fid = d._id ? d._id : -1;
                                    //console.log("_id", fid);
                                    //console.log("typeof _id", typeof fid);
                                    friends_set.add(fid);

                                    // const name = d.name ? d.name : "ANONYMOUS_USER";
                                    // const name_box = $("<div></div>");
                                    // const name_p = $("<p></p>").text(`name:${name}`);
                                    // name_box.append(name_p);
                                    // friend_case.append(name_box);

                                    // const date = d.date ? d.date : Date.now();
                                    // const date_box = $("<div></div>");
                                    // const date_p = $("<p></p>").text(`Joined on: ${date}`);
                                    // date_box.append(date_p);
                                    // friend_case.append(date_box);
                                    // friend_box.append(friend_case);
                                }
                                // $(".friend_box").hide();
                            } catch (err) {
                                console.log("err in expanding friend data: ", err);
                            }
                        })
                        .catch((err) => {
                            console.log("err:", err);
                        });

                    // get favorite list here
                    axios
                        .get(`${main_host}/favorite?email=${email}`, {
                            headers: {
                                "Access-Control-Allow-Origin": "*",
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                            },
                        })
                        .then((response) => {
                            try {
                                const data = response.data.favorite;
                                //console.log("response data: ", data);
                                // const favorite = $("<div></div>").attr({
                                //     class: "favorite_box",
                                // });
                                // $("#favorite_container").append(favorite);

                                for (d of data) {
                                    const item = d.data;

                                    // const name = item.rname ? item.rname : "ANONYMOUS_UNIT";
                                    const rid = item.rid ? item.rid : -1;
                                    console.log("rid: ", rid);
                                    console.log(
                                        "favorite_set has rid?",
                                        favorite_set.has(rid) ? true : false
                                    );
                                    console.log("favorite_set: ", favorite_set);
                                    favorite_set.add(rid);
                                    // const favorite_case = $("<div></div>").attr({
                                    //     class: "favorite_case",
                                    // });
                                    // favorite.append(favorite_case);
                                    // const name_box = $("<div></div>");
                                    // const name_p = $("<p></p>").text(`name:${name}`);
                                    // name_box.append(name_p);
                                    // favorite_case.append(name_box);
                                }
                                // $(".favorite_box").hide();
                            } catch (err) {
                                console.log("err in expanding friend data: ", err);
                            }
                            // display favorite restaurants
                        })
                        .catch((err) => {
                            // display error
                            console.log("error in get favorite: ", err);
                        });
                }
                // verify successful
            )
            .catch((err) => {
                // verify failed
            });

        ////
        $("#trigger_signup").click((event) => {
            console.log("pressed sign up");
            $("#id_container-register100").hide();
            axios
                .post(
                    `${main_host}/signup`, {
                        name: $("#signup_input_name").val(),
                        email: $("#signup_input_email").val(),
                        password: $("#signup_input_password").val(),
                    }, {
                        headers: {
                            "Access-Control-Allow-Origin": "*",
                            "Content-Type": "application/json",
                        },
                    }
                )
                .then((response) => {
                    //console.log(JSON.stringify(response.data.state));
                    const token = response.data.token;
                    if (!token) {
                        //failed signing up
                        alert("註冊失敗: 沒有取得JWT");
                        console.log("error: did not receive token");
                        //console.log("response.data: ", response.data);
                    } else {
                        //signed up successfully
                        const token = response.data.token;
                        localStorage.setItem("jwt", token);
                        //$("#div_signup").hide();
                        //$("#div_signin").hide();
                        $("#show_signin").hide();
                        $("#show_signup").hide();
                        $("#div_signout").show();
                        $("#div_profile").show();
                    }
                })
                .catch((err) => {
                    //failed signing up
                    alert("註冊失敗: 其他原因");
                    $("#id_container-register100").hide();

                    console.log("An error occurred:", err);
                })
                .finally(() => {
                    $("#signup_input_name").val("");
                    $("#signup_input_email").val("");
                    $("#signup_input_password").val("");
                    console.log("finally of signing up");
                });
        });

        $("#trigger_signin").click((event) => {
            console.log("pressed sign in");
            $("#id_container-login100").hide();
            axios
                .post(
                    `${main_host}/signin`, {
                        email: $("#signin_input_email").val(),
                        password: $("#signin_input_password").val(),
                    }, {
                        headers: {
                            "Access-Control-Allow-Origin": "*",
                            "Content-Type": "application/json",
                        },
                    }
                )
                .then((response) => {
                    // receive JWT; signed in successfully
                    //console.log("response.data: ", response.data);
                    if (!response.data.token) {
                        // failed signing in
                        // QQQ. 後端要再確認一下：這邊註冊跟登入前端流程一樣，失敗時，alert結果卻不同。why?
                        alert("登入失敗: 未取得JWT");
                    } else {
                        // 成功登入
                        $("#trigger_profile").trigger("click");
                        const token = response.data.token;
                        localStorage.setItem("jwt", token);
                        $("#show_signin").hide();
                        $("#show_signup").hide();
                        $("#div_signout").show();
                        $("#div_profile").show();
                    }
                    console.log(JSON.stringify(response.data.state));
                })
                .catch((err) => {
                    console.log("An error occurred:", err);
                    alert("登入失敗: 其他原因");
                })
                .finally(() => {
                    $("#signin_input_name").val("");
                    $("#signin_input_email").val("");
                    $("#signin_input_password").val("");
                    console.log("finally");
                });
        });

        $("#trigger_signout").click((event) => {
            console.log("press sign out");
            localStorage.removeItem("jwt");
            //$("#div_signup").show();
            //$("#div_signin").show();
            $("#show_signin").show();
            $("#show_signup").show();
            $("#profile_container").remove();
            $("#friend_container").remove();
            $("#favorite_container").remove();
            $("#div_signout").hide();
            $("#div_profile").hide();
            $("#filters").show();
            personal_token = "";
        });

        // SQQQ.你拿profile為什麼要打兩次API? 應該一次就夠了
        $("#trigger_profile").click(async(event) => {
            console.log("trigger profile");
            $("#profile_container").remove();
            $("#friend_container").remove();
            $("#favorite_container").remove();

            const token = localStorage.getItem("jwt");
            let profile_flag = 0;

            // verify token first and set flag
            profile_flag = await (async function() {
                if (!token) {
                    $("#div_signout").hide();
                    return 0;
                }
                return axios
                    .post(
                        `${main_host}/verify_token`, {}, {
                            headers: {
                                "Access-Control-Allow-Origin": "*",
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`,
                            },
                        }
                    )
                    .then((response) => {
                        if (response.data.new_token) {
                            // successfully verifying token
                            // do we really need to renew token everytime?
                            // considering add parameter(s) to verify_token API
                            // to judge if we would renew the token when verifying.
                            localStorage.setItem("jwt", response.data.new_token);
                            personal_token = response.data.personal_token;
                            // authenticated; positive
                            //$("#div_signup").hide();
                            //$("#div_signin").hide();
                            //$("#id_container-login100").hide();
                            $("#show_signin").hide();
                            $("#show_signup").hide();
                            $("#div_signout").show();
                            //$("#div_signout").show();
                            //display profile for user
                            console.log("status checked, signed in");
                            return 1;
                        } else {
                            // authenticated; negative
                            console.log(JSON.stringify(response.data.state));
                            $("#show_signup").show();
                            $("#show_signin").show();
                            $("#div_signout").hide();
                            return 0;
                        }
                    })
                    .catch((err) => {
                        // authenticated; negative
                        console.log("error: ", err);
                        console.log(JSON.stringify(response.data.state));
                        $("#show_signup").show();
                        $("#show_signin").show();
                        $("#div_signout").hide();
                        return 0;
                    });
            })();
            // status check
            // console.log("profile_flag: ", profile_flag);
            if (profile_flag === 0) {
                // failed
            } else {
                // profile_flag === 1
                // SQQQ.你也知道verify_token沒用，那第一次應該也不用打了
                // R. 不過POST verify_token才會有renewed token, GET profile是不會拿到新token的
                // 這樣或許比較好
                const obj = axios
                    .get(`${main_host}/profile`, {
                        headers: {
                            "Access-Control-Allow-Origin": "*",
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                        },
                    })
                    .then(
                        (response) => {
                            $("#filters").hide();
                            $("#restaurant_container").hide();
                            $("#pagination").hide();

                            $("#detail_display").hide();
                            const req_status = response.data.state;
                            console.log("response.data:", response.data);
                            console.log("response:", response);
                            // debugging msg
                            console.log("Get profile status:", req_status);
                            // profile_data contains only data decoded from token
                            const profile_data = response.data.profile;
                            // if not profile_data應該要處理一下，雖然目前應該不會發生
                            let div_profile = $("<div></div>").attr({
                                id: "profile_container",
                            });
                            // friend list
                            let div_friend = $("<div></div>").attr({
                                id: "friend_container",
                            });
                            // favorite restaurants/collection
                            let div_favorite = $("<div></div>").attr({
                                id: "favorite_container",
                            });
                            $("#root").append(div_profile);
                            $("#root").append(div_friend);
                            $("#root").append(div_favorite);

                            //set personal token for more purposes
                            personal_token = profile_data["email"] ?
                                profile_data["email"] :
                                "";
                            // display available features of user

                            for (k of Object.keys(profile_data)) {
                                // 這2個keys暫時不處理；放到其他按鈕來處理
                                if (k === "friends") {
                                    continue;
                                } else if (k === "favorite") {
                                    continue;
                                }
                                let profile_key = $("<p></p>").attr({
                                    id: `profile_div_${k}`,
                                });
                                profile_key.html(`${k}: ${profile_data[k]}`);
                                div_profile.append(profile_key);
                            }
                            div_friend.append(
                                $("<button id='show_friend'>美食同好</button>")
                            );
                            div_favorite.append(
                                $("<button id='show_favorite'>口袋名單</button>")
                            );
                            // get friend and favorite here
                            // UPDATE: friend done;
                            // should have token here
                            let email;
                            try {
                                email = personal_token.replace(".", "%2E");
                            } catch (err) {
                                console.log("error occurred when urlencoding email:", err);
                                return;
                            }

                            // get friend list here
                            axios
                                .get(`${main_host}/friends?email=${email}`, {
                                    headers: {
                                        "Access-Control-Allow-Origin": "*",
                                        "Content-Type": "application/json",
                                        Authorization: `Bearer ${token}`,
                                    },
                                })
                                .then((response) => {
                                    try {
                                        const data = response.data;
                                        console.log("response data: ", data);
                                        const friend_box = $("<div></div>").attr({
                                            class: "friend_box",
                                        });
                                        $("#friend_container").append(friend_box);

                                        for (d of data) {
                                            const friend_case = $("<div></div>").attr({
                                                class: "friend_case",
                                            });

                                            const fid = d._id ? d._id : -1;
                                            //console.log("_id", fid);
                                            //console.log("typeof _id", typeof fid);
                                            friends_set.add(fid);

                                            const name = d.name ? d.name : "ANONYMOUS_USER";
                                            const name_box = $("<div></div>");
                                            const name_p = $("<p></p>").text(`name:${name}`);
                                            name_box.append(name_p);
                                            friend_case.append(name_box);

                                            const date = d.date ? d.date : Date.now();
                                            const date_box = $("<div></div>");
                                            const date_p = $("<p></p>").text(`Joined on: ${date}`);
                                            date_box.append(date_p);
                                            friend_case.append(date_box);
                                            friend_box.append(friend_case);
                                        }
                                        $(".friend_box").hide();
                                    } catch (err) {
                                        console.log("err in expanding friend data: ", err);
                                    }
                                })
                                .catch((err) => {
                                    console.log("err:", err);
                                });

                            // get favorite list here
                            axios
                                .get(`${main_host}/favorite?email=${email}`, {
                                    headers: {
                                        "Access-Control-Allow-Origin": "*",
                                        "Content-Type": "application/json",
                                        Authorization: `Bearer ${token}`,
                                    },
                                })
                                .then((response) => {
                                    console.log("response:", response);
                                    try {
                                        const data = response.data.favorite;
                                        console.log("response data: ", data);
                                        const favorite = $("<div></div>").attr({
                                            class: "favorite_box",
                                        });
                                        $("#favorite_container").append(favorite);

                                        for (d of data) {
                                            const item = d.data;

                                            const name = item.rname ? item.rname : "ANONYMOUS_UNIT";
                                            const rid = item.rid ? item.rid : -1;
                                            favorite_set.add(rid);
                                            console.log("get favorite list: ", favorite);
                                            const favorite_case = $("<div></div>").attr({
                                                class: "favorite_case",
                                            });
                                            favorite.append(favorite_case);
                                            const name_box = $("<div></div>");
                                            const name_p = $("<p></p>").text(`name:${name}`);
                                            name_box.append(name_p);
                                            favorite_case.append(name_box);
                                        }
                                        $(".favorite_box").hide();
                                    } catch (err) {
                                        console.log("err in expanding friend data: ", err);
                                    }
                                    // display favorite restaurants
                                })
                                .catch((err) => {
                                    // display error
                                    console.log("error in get favorite: ", err);
                                });
                            // display features not available yet:

                            // first remove those we already have on browser
                            let residual_feature = new Set(user_features);
                            // 舊的做法：當前資料有的欄位就不顯示在input讓人修改
                            // 顯然不合理
                            // for (i of Object.keys(profile_data)) {
                            //     residual_feature.delete(i);
                            // }
                            // email目前不能修改

                            // for (i of Object.keys(profile_data)) {
                            //     residual_feature.delete(i);
                            // }
                            // email目前不能修改
                            residual_feature.delete("email");

                            let extra_profile = $("<div></div>").attr({
                                id: `extra_profile`,
                            });
                            div_profile.append(extra_profile);
                            let form = $("<form></form>").attr({
                                method: "post",
                                action: "javascript:console.log('oh~oh~oh');",
                            });
                            extra_profile.append(form);
                            //
                            for (i of residual_feature) {
                                let label = $("<label></label>").attr({
                                    for: `${i}`,
                                });
                                label.html(`${i}:`);
                                let input = $("<input></input>").attr({
                                    name: `${i}`,
                                    type: "text",
                                    class: "update_feature",
                                    value: `${profile_data[i] ? profile_data[i] : ""}`,
                                    //id: `update_feature_${i}`,
                                });
                                form.append(label);
                                form.append(input);
                                form.append("<br />");
                            }
                            let update_profile_btn = $(
                                "<button id='update_profile'>更新資料</button>"
                            );
                            form.append(update_profile_btn);

                            let update_body = {};
                            // QQQ.成功更新資料之後應該要刷新頁面
                            // when pressing 更新資料
                            $(document).on("click", "#update_profile", () => {
                                console.log("very cool");
                                $("input.update_feature").each(function(index, element) {
                                    // console.log(Object.keys(element));
                                    // console.log(typeof element.name);
                                    update_body[`${element.name}`] = `${element.value}`;
                                    // console.log("element:");
                                    //
                                    // this is not gonna work:
                                    // console.log(`${element.attr("name")}`);
                                });
                                // console.log("update_body: ", JSON.stringify(update_body));
                                const token = localStorage.getItem("jwt");
                                axios
                                    .post(`${main_host}/profile`, update_body, {
                                        headers: {
                                            "Access-Control-Allow-Origin": "*",
                                            "Content-Type": "application/json",
                                            Authorization: `Bearer ${token}`,
                                        },
                                    })
                                    .then((response) => {
                                        alert("資料修改成功");
                                    })
                                    .catch((err) => {
                                        alert("更改資料失敗");
                                    });
                            });
                            //update_profile_btn prevent default
                            //post data to server
                            // if failed: do something
                            //if successful: rerender page
                        }
                        // verify successful
                    )
                    .catch((err) => {
                        // verify failed
                    });
            }
        });

        // 美食同好 按鈕
        //口袋名單 按鈕
        // QQQ. toggle: 顯示/隱藏
        let friend_toggle = 0;
        $(document).on("click", "#show_friend", () => {
            if (friend_toggle === 0) {
                $(".friend_box").show();
                friend_toggle = 1;
            } else {
                $(".friend_box").hide();
                friend_toggle = 0;
            }

            // const token = localStorage.getItem("jwt");
            // if (!token) {
            //     // QQQ.這個地方可能需要一起把 #signin / #signup 加回去(不只這邊)
            //     $("#div_signout").hide();
            //     $("#div_profile").hide();
            // } else {
            //     let email;
            //     try {
            //         email = personal_token.replace(".", "%2E");
            //     } catch (err) {
            //         console.log("error occurred when urlencoding email:", err);
            //         return;
            //     }
            //     axios
            //         .get(`${main_host}/friends?email=${email}`, {
            //             headers: {
            //                 "Access-Control-Allow-Origin": "*",
            //                 "Content-Type": "application/json",
            //                 Authorization: `Bearer ${token}`,
            //             },
            //         })
            //         .then((response) => {
            //             try {
            //                 const data = response.data;
            //                 console.log("response data: ", data);
            //                 for (d of data) {
            //                     const friend = $("<div></div>").attr({
            //                         class: "friend_box",
            //                     });
            //                     $("#friend_container").append(friend);
            //                     const name = d.name ? d.name : "ANONYMOUS_USER";
            //                     const name_box = $("<div></div>");
            //                     const name_p = $("<p></p>").text(`name:${name}`);
            //                     name_box.append(name_p);
            //                     friend.append(name_box);

            //                     const date = d.date ? d.date : Date.now();
            //                     const date_box = $("<div></div>");
            //                     const date_p = $("<p></p>").text(`Joined on: ${date}`);
            //                     date_box.append(date_p);
            //                     friend.append(date_box);
            //                 }
            //             } catch (err) {
            //                 console.log("err in expanding friend data: ", err);
            //             }
            //         })
            //         .catch((err) => {});
            // }
        });
        let favorite_toggle = 0;
        $(document).on("click", "#show_favorite", () => {
            if (favorite_toggle === 0) {
                $(".favorite_box").show();
                favorite_toggle = 1;
            } else {
                $(".favorite_box").hide();
                favorite_toggle = 0;
            }

            // const token = localStorage.getItem("jwt");
            // if (!token) {
            //     $("#div_signout").hide();
            //     $("#div_profile").hide();
            // } else {
            //     let email;
            //     try {
            //         email = personal_token.replace(".", "%2E");
            //     } catch (err) {
            //         console.log("error occurred when urlencoding email:", err);
            //         return;
            //     }
            //     axios
            //         .get(`${main_host}/favorite?email=${email}`, {
            //             headers: {
            //                 "Access-Control-Allow-Origin": "*",
            //                 "Content-Type": "application/json",
            //                 Authorization: `Bearer ${token}`,
            //             },
            //         })
            //         .then((response) => {
            //             console.log("response:", response);
            //             try {
            //                 const data = response.data.favorite;
            //                 console.log("response data: ", data);
            //                 for (d of data) {
            //                     const item = d.data;
            //                     const favorite = $("<div></div>").attr({
            //                         class: "favorite_box",
            //                     });
            //                     $("#favorite_container").append(favorite);
            //                     const name = item.rname ? item.rname : "ANONYMOUS_UNIT";
            //                     const name_box = $("<div></div>");
            //                     const name_p = $("<p></p>").text(`name:${name}`);
            //                     name_box.append(name_p);
            //                     favorite.append(name_box);
            //                 }
            //             } catch (err) {
            //                 console.log("err in expanding friend data: ", err);
            //             }
            //             // display favorite restaurants
            //         })
            //         .catch((err) => {
            //             // display error
            //             console.log("error in get favorite: ", err);
            //         });
            // }
        });

        // 細節頁的收藏按鈕
        $(document).on("click", "#add_favorite", () => {
            const token = localStorage.getItem("jwt");
            if (!token) {
                // QQQ.這個地方可能需要一起把 #signin / #signup 加回去(不只這邊)
                // R: 已經加了，之後再確認別的地方
                $("#div_signout").hide();
                $("#div_profile").hide();
                $("#show_signin").show();
                $("#show_signup").show();
            } else {
                const rid = $("#add_favorite").siblings(".rid").text();
                let rname = $("#add_favorite").siblings("#detail_name").text();
                rname = rname.replace("名稱：", "");
                const restaurant_obj = {
                    rid,
                    rname,
                };
                console.log("current rid: ", rid);
                console.log("current rname: ", rname.replace("名稱：", ""));

                let is_favorite = favorite_set.has(rid);
                if (1) {
                    axios
                        .post(
                            `${main_host}/favorite`, {
                                personal_token,
                                restaurant_obj,
                                action: is_favorite ? 0 : 1, //0: remove; 1: add
                            }, {
                                headers: {
                                    "Access-Control-Allow-Origin": "*",
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                },
                            }
                        )
                        .then((response) => {
                            const data = response.data;
                            //log state
                            console.log("is_favorite: ", is_favorite);
                            if (is_favorite) {
                                // 移除高光
                                favorite_set.delete(rid);
                                $("#add_favorite").removeClass("favorite_store_t");
                                $("#add_favorite").addClass("favorite_store_f");
                            } else {
                                //顯示高光
                                favorite_set.add(rid);
                                $("#add_favorite").removeClass("favorite_store_f");
                                $("#add_favorite").addClass("favorite_store_t");
                            }

                            // console.log(
                            //     "add favorite successful response:",
                            //     JSON.stringify(response)
                            // );
                        })
                        .catch((err) => {
                            // log error
                            console.log(
                                "add favorite Unsuccessful response:",
                                JSON.stringify(err)
                            );
                        });
                }
            }
        });

        // 結果頁的收藏按鈕
        $(document).on("click", ".favorite_ff", (event) => {
            const token = localStorage.getItem("jwt");
            if (!token) {
                // QQQ.這個地方可能需要一起把 #signin / #signup 加回去(不只這邊)
                // R: 已經加了，之後再確認別的地方
                $("#div_signout").hide();
                $("#div_profile").hide();
                $("#show_signin").show();
                $("#show_signup").show();
            } else {
                const target = $(event.target);
                // console.log("target: ", target);
                // console.log("event.target", event.target);
                const rid = target.children("p").text();
                const rname = target.siblings(".item_real_name").text();
                const restaurant_obj = {
                    rid,
                    rname,
                };
                console.log("current rid: ", rid);
                console.log("current rname: ", rname.replace("名稱：", ""));

                let is_favorite = favorite_set.has(rid);
                //console.log("is_favorite:", is_favorite);
                if (1) {
                    axios
                        .post(
                            `${main_host}/favorite`, {
                                personal_token,
                                restaurant_obj,
                                action: is_favorite ? 0 : 1, //0: remove; 1: add
                            }, {
                                headers: {
                                    "Access-Control-Allow-Origin": "*",
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                },
                            }
                        )
                        .then((response) => {
                            const data = response.data;
                            //log state
                            //console.log("is_favorite: ", is_favorite);
                            if (is_favorite) {
                                // 移除高光
                                favorite_set.delete(rid);
                                target.removeClass("favorite_store_t");
                                target.addClass("favorite_store_f");
                            } else {
                                //顯示高光
                                favorite_set.add(rid);
                                target.removeClass("favorite_store_f");
                                target.addClass("favorite_store_t");
                            }

                            // console.log(
                            //     "add favorite successful response:",
                            //     JSON.stringify(response)
                            // );
                        })
                        .catch((err) => {
                            // log error
                            console.log(
                                "add favorite Unsuccessful response:",
                                JSON.stringify(err)
                            );
                        });
                }
            }
        });

        let place = $("#id_label_1"),
            exotic = $("#id_label_2"),
            estab = $("#id_label_3"),
            menu = $("#id_label_4"),
            pricelv = $("#id_label_5"),
            rating = $("#id_label_6"),
            ophour = $("#id_label_7"),
            amenit = $("#id_label_8"),
            opennow = $("#id_label_9");

        // QQQ. 按照現在的邏輯，按下搜尋時要把profile(div_profile) 藏起來
        $("#selected_fire").click((event) => {
            $(".pagination").remove();
            let place_arr = [];
            let selected_place = place.find(":selected");
            for (i of selected_place) {
                place_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let exotic_arr = [];
            let selected_exotic = exotic.find(":selected");
            for (i of selected_exotic) {
                exotic_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let estab_arr = [];
            let selected_estab = estab.find(":selected");
            for (i of selected_estab) {
                estab_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let menu_arr = [];
            let selected_menu = menu.find(":selected");
            for (i of selected_menu) {
                menu_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let pricelv_arr = [];
            let selected_pricelv = pricelv.find(":selected");
            for (i of selected_pricelv) {
                pricelv_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let rating_arr = [];
            let selected_rating = rating.find(":selected");
            for (i of selected_rating) {
                rating_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let ophour_arr = [];
            let selected_ophour = ophour.find(":selected");
            for (i of selected_ophour) {
                ophour_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let amenit_arr = [];
            let selected_amenit = amenit.find(":selected");
            for (i of selected_amenit) {
                amenit_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let opennow_arr = [];
            let selected_opennow = opennow.find(":selected");
            for (i of selected_opennow) {
                opennow_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            // console.log("sel_place: ", sel_place);
            // $("#root").append(`<p>${sel_place}</p>`);

            axios
                .post(
                    `${main_host}/search_experiment`, {
                        place: place_arr, //formatted_address
                        exotic: exotic_arr, //reviews.text
                        estab: estab_arr, //reviews.text
                        menu: menu_arr, //reviews.text
                        pricelv: pricelv_arr,
                        rating: rating_arr,
                        ophour: ophour_arr, ////reviews.text e.g.早餐，午餐，晚餐
                        amenit: amenit_arr, //reviews.text
                        opennow: opennow_arr, //
                    }, {
                        headers: {
                            "Access-Control-Allow-Origin": "*",
                            "Content-Type": "application/json",
                        },
                    }
                )
                .then((response) => {
                    const data = response.data;
                    //$("#root").append(`<p>${JSON.stringify(data.hits)}</p>`);
                    console.log(data);
                    $("#restaurant_container").remove();
                    $("#detail_display").remove();

                    // QQQ.我覺得這要再考慮一下。可能設個計時器，超過時間才remove，不然hide就好。
                    $("#profile_container").remove();
                    $("#friend_container").remove();
                    $("#favorite_container").remove();

                    hits_arr = [];
                    page_len = data.hits.hits.length;
                    data.hits.hits.forEach((element, index) => {
                        // if (index !== 0) {
                        //     return;
                        // }
                        hits_arr.push({
                            data: element._source,
                            id: element._id,
                        });
                    });
                    console.log("length of hits_arr: ", hits_arr.length);
                    cnt = 0;
                    let div_container = $("<div></div>").attr({
                        id: "restaurant_container",
                    });
                    let div_membrane = $("<div></div>").attr({
                        id: "restaurant_membrane",
                    });
                    $("#root").append(div_container);
                    $("#restaurant_container").append(div_membrane);

                    let is_favorite = 0;
                    for (ho of hits_arr) {
                        const h = ho.data;
                        //console.log(ho.id);
                        let div_box = $("<div></div>").attr({
                            id: `h${cnt}`,
                            class: "restaurant_box",
                        });
                        //$("#restaurant_container").append(div_box);
                        div_membrane.append(div_box);
                        is_favorite = favorite_set.has(ho.id);
                        //"<div><img src='./hoshizora.svg' alt='Hoshi'></div>"
                        const starred = $("<div>收藏</div>").attr({
                            class: is_favorite ? "favorite_store_t" : "favorite_store_f",
                        });
                        starred.addClass("favorite_ff");
                        const id_content = $(`<p>${ho.id}</p>`).css("display", "none");
                        starred.append(id_content);
                        div_box.append(starred);
                        div_box.append(
                            `<p class="item_name" id="item_title_${cnt}">名稱：${cnt + 1}.${
                  h.name
                }</p>`
                        );
                        div_box.append(
                            `<p class="item_real_name" style="display:none">${h.name}</p>`
                        );

                        div_box.append(
                            `<p class="item_address">地址：${h.formatted_address}</p>`
                        );
                        div_box.append(`<p class="item_rating">評分：${h.rating}</p>`);

                        let plv = h.price_level;
                        if (!plv) {
                            plv = 0;
                        } else {
                            const plv_cnt = plv;
                            plv = "";
                            for (plv_i = 0; plv_i < plv_cnt; plv_i++) {
                                plv += "$";
                            }
                        }
                        div_box.append(`<p class="item_pricing">價位：${plv}</p>`);

                        let opening_hours;
                        try {
                            opening_hours = h.opening_hours.weekday_text;
                        } catch (err) {
                            console.log(
                                "An error occurred, might haven't caught data weekday_text correctly:",
                                err
                            );
                            opening_hours = "無資料";
                        }

                        div_box.append(
                            `<p class="item_ophour">營業時間：${opening_hours}</p>`
                        );
                        let today = new Date();
                        today = today.getDay();
                        let opendays = new Set();
                        try {
                            const period = h.opening_hours.periods;
                            for (p of period) {
                                for (k of Object.keys(p)) {
                                    if (p[k]["day"]) {
                                        //console.log("p[k]['day']: ", p[k]["day"]);
                                        opendays.add(p[k]["day"]);
                                    }
                                }
                            }
                        } catch (err) {
                            console.log(
                                "An error occurred, might haven't caught data periods correctly:",
                                err,
                                "will set all days open for the time being"
                            );
                            opendays.add(-2147483648);
                        }
                        //console.log("opendays: ", opendays);
                        div_box.append(
                            `<p class="item_ophour">營業日：${Array.from(opendays).join(
                  "-"
                )}</p>`
                        );
                        div_box.append(`<p>今天星期${today}</p>`);

                        cnt++;
                    }
                    (function($) {
                        let pagify = {
                            items: {},
                            container: null,
                            totalPages: 1,
                            perPage: 3,
                            currentPage: 0,
                            createNavigation: function() {
                                this.totalPages = Math.ceil(this.items.length / this.perPage);
                                console.log("total pages: ", this.totalPages);

                                $(".pagination", this.container.parent()).remove();
                                let pagination = $(
                                    '<div class="pagination" id="pagination"></div>'
                                ).append(
                                    '<a class="nav prev disabled" data-next="false"><</a>'
                                );

                                for (let i = 0; i < this.totalPages; i++) {
                                    let pageElClass = "page";
                                    if (!i) pageElClass = "page current";
                                    let pageEl =
                                        '<a class="' +
                                        pageElClass +
                                        '" data-page="' +
                                        (i + 1) +
                                        '">' +
                                        (i + 1) +
                                        "</a>";
                                    pagination.append(pageEl);
                                }
                                pagination.append(
                                    '<a class="nav next" data-next="true">></a>'
                                );

                                this.container.after(pagination);

                                let that = this;
                                $("body").off("click", ".nav");
                                this.navigator = $("body").on("click", ".nav", function() {
                                    let el = $(this);
                                    that.navigate(el.data("next"));
                                });

                                $("body").off("click", ".page");
                                this.pageNavigator = $("body").on(
                                    "click",
                                    ".page",
                                    function() {
                                        let el = $(this);
                                        that.goToPage(el.data("page"));
                                    }
                                );
                            },
                            navigate: function(next) {
                                // default perPage to 5
                                if (isNaN(next) || next === undefined) {
                                    next = true;
                                }
                                $(".pagination .nav").removeClass("disabled");
                                if (next) {
                                    this.currentPage++;
                                    if (this.currentPage > this.totalPages - 1)
                                        this.currentPage = this.totalPages - 1;
                                    if (this.currentPage == this.totalPages - 1)
                                        $(".pagination .nav.next").addClass("disabled");
                                } else {
                                    this.currentPage--;
                                    if (this.currentPage < 0) this.currentPage = 0;
                                    if (this.currentPage == 0)
                                        $(".pagination .nav.prev").addClass("disabled");
                                }

                                this.showItems();
                            },
                            updateNavigation: function() {
                                let pages = $(".pagination .page");
                                pages.removeClass("current");
                                $(
                                    '.pagination .page[data-page="' +
                                    (this.currentPage + 1) +
                                    '"]'
                                ).addClass("current");
                            },
                            goToPage: function(page) {
                                this.currentPage = page - 1;

                                $(".pagination .nav").removeClass("disabled");
                                if (this.currentPage == this.totalPages - 1)
                                    $(".pagination .nav.next").addClass("disabled");

                                if (this.currentPage == 0)
                                    $(".pagination .nav.prev").addClass("disabled");
                                this.showItems();
                            },
                            showItems: function() {
                                this.items.hide();
                                let base = this.perPage * this.currentPage;
                                this.items.slice(base, base + this.perPage).show();

                                this.updateNavigation();
                            },
                            init: function(container, items, perPage) {
                                this.container = container;
                                this.currentPage = 0;
                                this.totalPages = 1;
                                this.perPage = perPage;
                                this.items = items;
                                this.createNavigation();
                                this.showItems();
                            },
                        };

                        // stuff it all into a jQuery method!
                        $.fn.pagify = function(perPage, itemSelector) {
                            let el = $(this);
                            let items = $(itemSelector, el);

                            // default perPage to 5
                            if (isNaN(perPage) || perPage === undefined) {
                                perPage = 3;
                            }

                            // don't fire if fewer items than perPage
                            if (items.length <= perPage) {
                                return true;
                            }

                            pagify.init(el, items, perPage);
                        };
                    })(jQuery);

                    if (hits_arr.length === 0) {
                        let empty_reminder_box = $("<div></div>");
                        let empty_reminder_p = $("<p>沒有你要找的餐廳</p>");
                        empty_reminder_box.append(empty_reminder_p);
                        div_membrane.append(empty_reminder_box);
                    }

                    $("#restaurant_container").pagify(10, ".restaurant_box");
                    $("#hide_search").show();
                    $("#modify_search").show();
                    $("#filters").hide();
                    console.log("success");
                })
                .catch((error) => {
                    console.log("An error occurred:", error);
                })
                .finally(() => {
                    console.log("finally");
                });

            // const print_data = `text_select_1: ,
            //   ${text_select_1},
            //   ${text_select_1.text()},
            //   ${text_select_1[0]},
            //   ${text_select_1.length},
            //   ${text_select_1[0].innerHTML},
            //   text_select_2: ,
            //   ${text_select_2.text()},
            //   text_select_3: ,
            //   ${text_select_3.text()}`;
            // console.log(
            //     // "val_select_1: ",
            //     // val_select_1,
            //     // "\nval_select_1: ",
            //     // val_select_1,
            //     // "\nval_select_1: ",
            //     // val_select_1,
            //     print_data
            // );
            // console.log(text_select_1);
            // console.log(text_select_1.text());
            // console.log(text_select_1[0]);
            // console.log(text_select_1.length);
            // console.log(text_select_1[0].innerHTML);
            // $("#root").append(`<div>${print_data}</div>`);
            //get length of selected options
            // $("#root").append(`<p>${text_select_1.length}</p>`);
            // $("#root").append(`<p>${text_select_2.length}</p>`);
        });
        $("#modify_search").click((event) => {
            $("#filters").show();
        });
        $("#hide_search").click((event) => {
            $("#filters").hide();
        });
        let test_cnt = 0;

        // for (let i_ = 0; i < page_len; i++) {
        for (let hits_i = 0; hits_i < 100; hits_i++) {
            //console.log("current hooked i: ", hits_i);
            $(document).on("dblclick", `#item_title_${hits_i}`, () => {
                let detail_data = hits_arr[hits_i].data;
                const rid = hits_arr[hits_i].id;
                //console.log("rid: ", rid);
                //console.log("the data is: ", JSON.stringify(detail_data));
                let detail_layout = $("<div></div>").attr({
                    id: "detail_display",
                });
                $("#root").append(detail_layout);
                // add to favorite
                detail_layout.append(`<div id="add_favorite">加入收藏</div>`);
                detail_layout.append(`<div class="rid">${rid}</div>`);
                detail_layout.append(
                    `<p id="detail_name">名稱：${detail_data.name}</p>`
                );
                // ddeebbuugg!!!!
                console.log(`The ${hits_i}th item is retrieved: ${detail_data.name}`);
                detail_layout.append(
                    `<p class="item_address">地址：${detail_data.formatted_address}</p>`
                );
                detail_layout.append(
                    `<p class="item_rating">評分：${detail_data.rating}</p>`
                );
                let plv = detail_data.price_level;
                if (!plv) {
                    plv = 0;
                } else {
                    const plv_cnt = plv;
                    plv = "";
                    for (_ = 0; _ < plv_cnt; _++) {
                        plv += "$";
                    }
                }
                detail_layout.append(`<p class="item_pricing">價位：${plv}</p>`);
                let opening_hours;
                try {
                    opening_hours = detail_data.opening_hours.weekday_text;
                } catch (err) {
                    console.log(
                        "An error occurred, might haven't caught data weekday_text correctly:",
                        err
                    );
                    opening_hours = "無資料";
                }

                detail_layout.append(
                    `<p class="item_ophour">營業時間：${opening_hours}</p>`
                );
                let today = new Date();
                today = today.getDay();
                let opendays = new Set();
                try {
                    const period = detail_data.opening_hours.periods;
                    for (p of period) {
                        for (k of Object.keys(p)) {
                            if (Object.prototype.hasOwnProperty.call(p[k], "day")) {
                                //console.log("p[k]['day']: ", p[k]["day"]);
                                opendays.add(p[k]["day"]);
                            }
                        }
                    }
                } catch (err) {
                    console.log(
                        "An error occurred, might haven't caught data periods correctly:",
                        err,
                        "will set all days open for the time being"
                    );
                    opendays.add(-2147483648);
                }
                //console.log("opendays: ", opendays);
                detail_layout.append(
                    `<p class="item_ophour">營業日：${Array.from(opendays).join(
              "-"
            )}</p>`
                );
                detail_layout.append(`<p>今天星期${today}</p>`);
                detail_layout.append("<br>");
                detail_layout.append("<br>");
                if (detail_data.formatted_phone_number != undefined) {
                    detail_layout.append(
                        `<p>電話：${detail_data.formatted_phone_number}</p>`
                    );
                } else {
                    detail_layout.append(`<p>電話：沒有資料</p>`);
                }

                if (detail_data.website != undefined) {
                    detail_layout.append(`<p>網站：${detail_data.website}</p>`);
                } else {
                    detail_layout.append(`<p>網站：沒有資料</p>`);
                }

                let reviews_div = $("<div></div>").attr({
                    id: `reviews_container`,
                });
                detail_layout.append(reviews_div);
                let review_cnt = 0;
                try {
                    for (r of detail_data.reviews) {
                        let single_review = $("<div></div>").attr({
                            id: `reviews_no_${review_cnt}`,
                            class: "review_box",
                        });
                        reviews_div.append(single_review);
                        //
                        single_review.append(`<p>姓名：${r.author_name}</p>`);
                        single_review.append(`<p>評分：${r.rating}</p>`);
                        single_review.append(`<p>評論：${r.text}</p>`);
                        review_cnt++;
                    }
                } catch (err) {
                    console.log("An error occurred while rendering reviews:", err);

                    let single_review = $("<div></div>").attr({
                        id: `reviews_no_${review_cnt}`,
                        class: "review_box",
                    });
                    reviews_div.append(single_review);
                    single_review.append(`<p>目前還沒有評論~</p>`);
                }

                //$("#root").append(`<p>${JSON.stringify(hits_arr[i])}</p>`);

                $("#restaurant_container").remove();
                $("#pagination").remove();
            });
        }

        $("#trigger_show_signin").click((event) => {
            $("#id_container-login100").show();
        });
        $("#trigger_show_signup").click((event) => {
            $("#id_container-register100").show();
        });
        // let container = $("#filters");
        // container.pagination
        $("body").click((event) => {
            console.log("oh~oh");

            if ($(event.target).attr("class") === "container-login100") {
                $(".container-login100").hide();
            }
        });
    </script>
</body>

</html>